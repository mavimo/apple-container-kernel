name: kernel-build

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    env:
      KIMAGE: kernel-build:0.1

    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Read kernel version
        id: read_kernel
        run: |
          KVERSION=$(cat kernel)
          echo "kernel_version=${KVERSION}" >> "$GITHUB_OUTPUT"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Apply patches
        run: |
          git apply --directory apple-containerization patches/0001-kernel-config.patch
          git apply --directory apple-containerization patches/0002-build-image.patch

      - name: Build the kernel builder Docker image
        run: |
          cd apple-containerization/kernel/
          docker build --platform linux/arm64 image/ -f image/Dockerfile -t ${KIMAGE}

      - name: Download kernel sources
        run: |
          cd apple-containerization/kernel/
          curl -SsL -o source.tar.xz https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${{ steps.read_kernel.outputs.kernel_version }}.tar.xz

      - name: Run kernel build
        run: |
          cd apple-containerization/kernel/
          docker run \
            --platform linux/arm64 \
            --volume .:/kernel \
            --workdir /kernel \
            ${KIMAGE} \
            /bin/bash -c "./build.sh"

      - name: Upload kernel build artifacts
        uses: actions/upload-artifact@v6
        with:
          retention-days: 30
          name: kernel
          path: apple-containerization/kernel/vmlinux
          if-no-files-found: error

      - name: Add comment with kernel build info
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## :package: Kernel Build Complete :package:
            The kernel has been successfully built! You can download the kernel image from the [Artifacts](../actions) section of this pull request.

            **Kernel Version:** `${{ steps.read_kernel.outputs.kernel_version }}`
            **Build Status:** âœ… Successful
